<!doctype html>
<html>
  <head>
    <title>Complaint Management - Food Safety Inspector</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      * { box-sizing: border-box; margin: 0; padding: 0; }
      body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f3f4f6; min-height: 100vh; }
      .header { background: #1E40AF; color: white; padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; }
      .header-left { display: flex; align-items: center; gap: 12px; }
      .header-logo { width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; }
      .header-logo svg { width: 24px; height: 24px; fill: white; }
      .header-title { font-size: 18px; font-weight: 600; }
      .header-right { display: flex; align-items: center; gap: 16px; }
      .back-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 16px; border-radius: 6px; font-size: 14px; cursor: pointer; text-decoration: none; }
      .back-btn:hover { background: rgba(255,255,255,0.2); }
      .main { padding: 24px; max-width: 1400px; margin: 0 auto; }
      .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
      .page-title { font-size: 24px; font-weight: 700; color: #1f2937; }
      .tabs { display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 2px solid #e5e7eb; padding-bottom: 0; }
      .tab { padding: 12px 24px; border: none; background: none; font-size: 14px; font-weight: 500; color: #6b7280; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all 0.2s; }
      .tab:hover { color: #1E40AF; }
      .tab.active { color: #1E40AF; border-bottom-color: #1E40AF; }
      .tab-content { display: none; }
      .tab-content.active { display: block; }
      .card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; margin-bottom: 24px; }
      .card-header { padding: 16px 20px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
      .card-title { font-size: 16px; font-weight: 600; color: #1f2937; }
      .add-btn { background: #1E40AF; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 13px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 6px; }
      .add-btn:hover { background: #1e3a8a; }
      .add-btn svg { width: 16px; height: 16px; fill: white; }
      table { width: 100%; border-collapse: collapse; }
      th { background: #f9fafb; padding: 12px 16px; text-align: left; font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase; border-bottom: 1px solid #e5e7eb; }
      td { padding: 14px 16px; border-bottom: 1px solid #e5e7eb; font-size: 14px; color: #1f2937; }
      tr:last-child td { border-bottom: none; }
      tr:hover { background: #f9fafb; }
      .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; display: inline-block; }
      .status-active { background: #d1fae5; color: #059669; }
      .status-inactive { background: #fee2e2; color: #dc2626; }
      .status-pending { background: #fef3c7; color: #92400e; }
      .status-assigned { background: #dbeafe; color: #1E40AF; }
      .status-resolved { background: #d1fae5; color: #059669; }
      .action-btns { display: flex; gap: 8px; }
      .action-btn { padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; border: none; }
      .edit-btn { background: #eff6ff; color: #1E40AF; }
      .edit-btn:hover { background: #dbeafe; }
      .delete-btn { background: #fef2f2; color: #dc2626; }
      .delete-btn:hover { background: #fee2e2; }
      .view-btn { background: #f0fdf4; color: #059669; }
      .view-btn:hover { background: #dcfce7; }
      .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
      .modal.show { display: flex; }
      .modal-content { background: white; border-radius: 12px; padding: 24px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
      .modal-title { font-size: 20px; font-weight: 600; margin-bottom: 20px; color: #1f2937; }
      .form-group { margin-bottom: 16px; }
      .form-label { display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 6px; }
      .form-input, .form-select, .form-textarea { width: 100%; padding: 10px 14px; font-size: 14px; border: 1px solid #d1d5db; border-radius: 8px; outline: none; }
      .form-textarea { min-height: 100px; resize: vertical; }
      .form-input:focus, .form-select:focus, .form-textarea:focus { border-color: #1E40AF; box-shadow: 0 0 0 3px rgba(30,64,175,0.1); }
      .modal-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; }
      .cancel-btn { padding: 10px 20px; border: 1px solid #d1d5db; background: white; border-radius: 8px; font-size: 14px; cursor: pointer; }
      .cancel-btn:hover { background: #f9fafb; }
      .save-btn { padding: 10px 20px; background: #1E40AF; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; }
      .save-btn:hover { background: #1e3a8a; }
      .empty-state { padding: 60px 20px; text-align: center; color: #6b7280; }
      .empty-state svg { width: 64px; height: 64px; fill: #d1d5db; margin-bottom: 16px; }
      .empty-state h3 { font-size: 18px; color: #374151; margin-bottom: 8px; }
      .options-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
      .option-tag { background: #f3f4f6; padding: 4px 10px; border-radius: 4px; font-size: 12px; color: #374151; display: flex; align-items: center; gap: 6px; }
      .option-remove { cursor: pointer; color: #dc2626; font-weight: bold; }
      .add-option-row { display: flex; gap: 8px; margin-top: 8px; }
      .add-option-input { flex: 1; }
      .add-option-btn { background: #059669; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; }
      .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
      .stat-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
      .stat-value { font-size: 28px; font-weight: 700; color: #1f2937; }
      .stat-label { font-size: 13px; color: #6b7280; margin-top: 4px; }
      .stat-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-bottom: 12px; }
      .stat-icon svg { width: 20px; height: 20px; }
      .copy-btn { background: #1E40AF; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer; display: inline-flex; align-items: center; gap: 4px; }
      .copy-btn:hover { background: #1e3a8a; }
      .copy-btn svg { width: 12px; height: 12px; fill: white; }
      .link-text { font-family: monospace; font-size: 12px; color: #6b7280; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: inline-block; vertical-align: middle; }
      .stat-icon.pink { background: #fce7f3; }
      .stat-icon.pink svg { fill: #be185d; }
      .stat-icon.blue { background: #dbeafe; }
      .stat-icon.blue svg { fill: #1E40AF; }
      .stat-icon.green { background: #d1fae5; }
      .stat-icon.green svg { fill: #059669; }
      .stat-icon.amber { background: #fef3c7; }
      .stat-icon.amber svg { fill: #d97706; }
      .complaint-code { font-family: monospace; font-weight: 600; color: #1E40AF; }
      .truncate { max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .date-cell { white-space: nowrap; font-size: 13px; color: #6b7280; }
      .filter-row { display: flex; gap: 12px; margin-bottom: 16px; padding: 0 16px; }
      .filter-input { padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; }
      .filter-select { padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; min-width: 150px; }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="header-left">
        <div class="header-logo">
          <svg viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>
        </div>
        <div>
          <div class="header-title">Complaint Management</div>
        </div>
      </div>
      <a href="/admin/dashboard" class="back-btn">Back to Dashboard</a>
    </header>

    <main class="main">
      <div class="page-header">
        <h1 class="page-title">Complaint Management</h1>
      </div>

      <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
          <div class="stat-icon pink">
            <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
          </div>
          <div class="stat-value" id="totalComplaints">0</div>
          <div class="stat-label">Total Complaints</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon amber">
            <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
          </div>
          <div class="stat-value" id="pendingComplaints">0</div>
          <div class="stat-label">Pending</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon blue">
            <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.31-8.86c-1.77-.45-2.34-.94-2.34-1.67 0-.84.79-1.43 2.1-1.43 1.38 0 1.9.66 1.94 1.64h1.71c-.05-1.34-.87-2.57-2.49-2.97V5H10.9v1.69c-1.51.32-2.72 1.3-2.72 2.81 0 1.79 1.49 2.69 3.66 3.21 1.95.46 2.34 1.15 2.34 1.87 0 .53-.39 1.39-2.1 1.39-1.6 0-2.23-.72-2.32-1.64H8.04c.1 1.7 1.36 2.66 2.86 2.97V19h2.34v-1.67c1.52-.29 2.72-1.16 2.73-2.77-.01-2.2-1.9-2.96-3.66-3.42z"/></svg>
          </div>
          <div class="stat-value" id="assignedComplaints">0</div>
          <div class="stat-label">Under Investigation</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon green">
            <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
          </div>
          <div class="stat-value" id="resolvedComplaints">0</div>
          <div class="stat-label">Resolved</div>
        </div>
      </div>

      <div class="tabs">
        <button class="tab active" onclick="switchTab('complaints')">Complaints</button>
        <button class="tab" onclick="switchTab('formConfig')">Form Configuration</button>
        <button class="tab" onclick="switchTab('statusWorkflow')">Status Workflow</button>
        <button class="tab" onclick="switchTab('sharedLinks')">Shared Links</button>
      </div>

      <div id="complaintsTab" class="tab-content active">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Submitted Complaints</div>
          </div>
          <div class="filter-row">
            <input type="text" class="filter-input" id="searchInput" placeholder="Search by code or name..." onkeyup="filterComplaints()">
            <select class="filter-select" id="statusFilter" onchange="filterComplaints()">
              <option value="">All Statuses</option>
              <option value="pending">Pending</option>
              <option value="assigned">Assigned</option>
              <option value="under_investigation">Under Investigation</option>
              <option value="resolved">Resolved</option>
              <option value="closed">Closed</option>
            </select>
          </div>
          <table>
            <thead>
              <tr>
                <th>Complaint ID</th>
                <th>Complainant</th>
                <th>Type / Nature</th>
                <th>Establishment</th>
                <th>Status</th>
                <th>Submitted</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="complaintsTableBody">
              <tr>
                <td colspan="7" class="empty-state">
                  <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
                  <h3>No complaints found</h3>
                  <p>Complaints submitted through the mobile app will appear here.</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div id="formConfigTab" class="tab-content">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Form Field Configuration</div>
            <button class="add-btn" onclick="openFormFieldModal()">
              <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
              Add Field
            </button>
          </div>
          <table>
            <thead>
              <tr>
                <th>Field Name</th>
                <th>Label</th>
                <th>Type</th>
                <th>Group</th>
                <th>Required</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="formFieldsTableBody">
            </tbody>
          </table>
        </div>
      </div>

      <div id="statusWorkflowTab" class="tab-content">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Status Transitions</div>
            <button class="add-btn" onclick="openWorkflowModal()">
              <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
              Add Transition
            </button>
          </div>
          <table>
            <thead>
              <tr>
                <th>From Status</th>
                <th>To Status</th>
                <th>Transition Name</th>
                <th>Required Role</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="workflowTableBody">
            </tbody>
          </table>
        </div>
      </div>

      <div id="sharedLinksTab" class="tab-content">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Shared Complaint Links</div>
            <button class="add-btn" onclick="openCreateLinkModal()">
              <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
              Create Link
            </button>
          </div>
          <table>
            <thead>
              <tr>
                <th>District</th>
                <th>Link</th>
                <th>Expires</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="sharedLinksTableBody">
            </tbody>
          </table>
        </div>
      </div>
    </main>

    <div class="modal" id="createLinkModal">
      <div class="modal-content">
        <h2 class="modal-title">Create Shared Link</h2>
        <div class="form-group">
          <label class="form-label">District</label>
          <select class="form-select" id="linkDistrictId" required>
            <option value="">Select district...</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Expires At (Optional)</label>
          <input type="datetime-local" class="form-input" id="linkExpiresAt">
        </div>
        <div class="modal-actions">
          <button class="cancel-btn" onclick="closeCreateLinkModal()">Cancel</button>
          <button class="save-btn" onclick="createSharedLink()">Create Link</button>
        </div>
      </div>
    </div>

    <div class="modal" id="formFieldModal">
      <div class="modal-content">
        <h2 class="modal-title" id="formFieldModalTitle">Add Form Field</h2>
        <input type="hidden" id="fieldId">
        <div class="form-group">
          <label class="form-label">Field Name (Internal)</label>
          <input type="text" class="form-input" id="fieldName" placeholder="e.g., complaint_type">
        </div>
        <div class="form-group">
          <label class="form-label">Display Label</label>
          <input type="text" class="form-input" id="fieldLabel" placeholder="e.g., Complaint Type">
        </div>
        <div class="form-group">
          <label class="form-label">Field Type</label>
          <select class="form-select" id="fieldType" onchange="toggleOptionsSection()">
            <option value="text">Text</option>
            <option value="textarea">Text Area</option>
            <option value="dropdown">Dropdown</option>
            <option value="date">Date</option>
            <option value="phone">Phone</option>
            <option value="email">Email</option>
            <option value="file">File Upload</option>
            <option value="location">Location</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Field Group</label>
          <select class="form-select" id="fieldGroup">
            <option value="complainant">Complainant Details</option>
            <option value="establishment">Establishment Details</option>
            <option value="incident">Incident Details</option>
            <option value="location">Location</option>
            <option value="evidence">Evidence</option>
          </select>
        </div>
        <div class="form-group" id="optionsSection" style="display: none;">
          <label class="form-label">Dropdown Options</label>
          <div class="options-list" id="optionsList"></div>
          <div class="add-option-row">
            <input type="text" class="form-input add-option-input" id="newOptionInput" placeholder="Add option...">
            <button class="add-option-btn" onclick="addOption()">Add</button>
          </div>
        </div>
        <div class="form-group" id="fileSettingsSection" style="display: none;">
          <label class="form-label">File Upload Settings</label>
          <div style="background: #f9fafb; padding: 12px; border-radius: 8px; margin-top: 8px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
              <div>
                <label class="form-label" style="font-size: 12px;">Max Files</label>
                <input type="number" class="form-input" id="maxFiles" value="3" min="1" max="10">
              </div>
              <div>
                <label class="form-label" style="font-size: 12px;">Max Size (MB)</label>
                <input type="number" class="form-input" id="maxSizeMB" value="5" min="1" max="20">
              </div>
            </div>
            <div style="margin-top: 12px;">
              <label class="form-label" style="font-size: 13px; font-weight: 600;">Watermark Settings</label>
              <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 8px;">
                <label style="font-size: 13px;"><input type="checkbox" id="watermarkEnabled" checked> Enable Watermark</label>
                <label style="font-size: 13px;"><input type="checkbox" id="watermarkShowGPS" checked> Show GPS Coordinates</label>
                <label style="font-size: 13px;"><input type="checkbox" id="watermarkShowTimestamp" checked> Show Timestamp</label>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px;">
                <div>
                  <label class="form-label" style="font-size: 12px;">Position</label>
                  <select class="form-select" id="watermarkPosition">
                    <option value="bottom-right">Bottom Right</option>
                    <option value="bottom-left">Bottom Left</option>
                    <option value="top-right">Top Right</option>
                    <option value="top-left">Top Left</option>
                  </select>
                </div>
                <div>
                  <label class="form-label" style="font-size: 12px;">Opacity</label>
                  <input type="number" class="form-input" id="watermarkOpacity" value="0.8" min="0.1" max="1" step="0.1">
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Display Order</label>
          <input type="number" class="form-input" id="displayOrder" value="0">
        </div>
        <div class="form-group">
          <label class="form-label">
            <input type="checkbox" id="isRequired"> Required field
          </label>
        </div>
        <div class="form-group">
          <label class="form-label">
            <input type="checkbox" id="isActive" checked> Active
          </label>
        </div>
        <div class="form-group">
          <label class="form-label">Help Text</label>
          <input type="text" class="form-input" id="helpText" placeholder="Instructions for user">
        </div>
        <div class="modal-actions">
          <button class="cancel-btn" onclick="closeFormFieldModal()">Cancel</button>
          <button class="save-btn" onclick="saveFormField()">Save</button>
        </div>
      </div>
    </div>

    <div class="modal" id="workflowModal">
      <div class="modal-content">
        <h2 class="modal-title" id="workflowModalTitle">Add Status Transition</h2>
        <input type="hidden" id="transitionId">
        <div class="form-group">
          <label class="form-label">From Status</label>
          <select class="form-select" id="fromStatus">
            <option value="pending">Pending</option>
            <option value="assigned">Assigned</option>
            <option value="under_investigation">Under Investigation</option>
            <option value="resolved">Resolved</option>
            <option value="closed">Closed</option>
            <option value="rejected">Rejected</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">To Status</label>
          <select class="form-select" id="toStatus">
            <option value="assigned">Assigned</option>
            <option value="under_investigation">Under Investigation</option>
            <option value="resolved">Resolved</option>
            <option value="closed">Closed</option>
            <option value="rejected">Rejected</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Transition Name</label>
          <input type="text" class="form-input" id="transitionName" placeholder="e.g., Assign to Officer">
        </div>
        <div class="form-group">
          <label class="form-label">Required Role</label>
          <select class="form-select" id="requiredRole">
            <option value="">Any Role</option>
            <option value="admin">Admin Only</option>
            <option value="officer">Officer</option>
            <option value="supervisor">Supervisor</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">
            <input type="checkbox" id="requiresEvidence"> Requires Evidence
          </label>
        </div>
        <div class="form-group">
          <label class="form-label">
            <input type="checkbox" id="requiresRemarks"> Requires Remarks
          </label>
        </div>
        <div class="form-group">
          <label class="form-label">
            <input type="checkbox" id="workflowActive" checked> Active
          </label>
        </div>
        <div class="modal-actions">
          <button class="cancel-btn" onclick="closeWorkflowModal()">Cancel</button>
          <button class="save-btn" onclick="saveWorkflow()">Save</button>
        </div>
      </div>
    </div>

    <div class="modal" id="complaintDetailModal">
      <div class="modal-content" style="max-width: 700px;">
        <h2 class="modal-title">Complaint Details</h2>
        <div id="complaintDetailContent"></div>
        <div class="modal-actions">
          <button class="cancel-btn" onclick="closeComplaintDetailModal()">Close</button>
        </div>
      </div>
    </div>

    <script>
      let currentOptions = [];
      let allComplaints = [];

      function switchTab(tabName) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById(tabName + 'Tab').classList.add('active');
      }

      function toggleOptionsSection() {
        const type = document.getElementById('fieldType').value;
        document.getElementById('optionsSection').style.display = type === 'dropdown' ? 'block' : 'none';
        document.getElementById('fileSettingsSection').style.display = type === 'file' ? 'block' : 'none';
      }

      function addOption() {
        const input = document.getElementById('newOptionInput');
        const value = input.value.trim();
        if (value) {
          currentOptions.push({ value: value, label: value });
          renderOptions();
          input.value = '';
        }
      }

      function removeOption(index) {
        currentOptions.splice(index, 1);
        renderOptions();
      }

      function renderOptions() {
        const list = document.getElementById('optionsList');
        list.innerHTML = currentOptions.map((opt, i) => 
          `<span class="option-tag">${opt.label}<span class="option-remove" onclick="removeOption(${i})">x</span></span>`
        ).join('');
      }

      function openFormFieldModal(field = null) {
        currentOptions = [];
        document.getElementById('fieldId').value = '';
        document.getElementById('fieldName').value = '';
        document.getElementById('fieldLabel').value = '';
        document.getElementById('fieldType').value = 'text';
        document.getElementById('fieldGroup').value = 'incident';
        document.getElementById('displayOrder').value = '0';
        document.getElementById('isRequired').checked = false;
        document.getElementById('isActive').checked = true;
        document.getElementById('helpText').value = '';
        document.getElementById('formFieldModalTitle').textContent = 'Add Form Field';
        
        // Reset file settings to defaults
        document.getElementById('maxFiles').value = '3';
        document.getElementById('maxSizeMB').value = '5';
        document.getElementById('watermarkEnabled').checked = true;
        document.getElementById('watermarkShowGPS').checked = true;
        document.getElementById('watermarkShowTimestamp').checked = true;
        document.getElementById('watermarkPosition').value = 'bottom-right';
        document.getElementById('watermarkOpacity').value = '0.8';

        if (field) {
          document.getElementById('fieldId').value = field.id;
          document.getElementById('fieldName').value = field.fieldName;
          document.getElementById('fieldLabel').value = field.fieldLabel;
          document.getElementById('fieldType').value = field.fieldType;
          document.getElementById('fieldGroup').value = field.fieldGroup;
          document.getElementById('displayOrder').value = field.displayOrder || 0;
          document.getElementById('isRequired').checked = field.isRequired;
          document.getElementById('isActive').checked = field.isActive;
          document.getElementById('helpText').value = field.helpText || '';
          if (field.dropdownOptions) {
            currentOptions = field.dropdownOptions;
          }
          // Load file settings from validationRules
          if (field.validationRules && field.fieldType === 'file') {
            const rules = field.validationRules;
            document.getElementById('maxFiles').value = rules.maxFiles || 3;
            document.getElementById('maxSizeMB').value = rules.maxSizeMB || 5;
            if (rules.watermark) {
              document.getElementById('watermarkEnabled').checked = rules.watermark.enabled !== false;
              document.getElementById('watermarkShowGPS').checked = rules.watermark.showGPS !== false;
              document.getElementById('watermarkShowTimestamp').checked = rules.watermark.showTimestamp !== false;
              document.getElementById('watermarkPosition').value = rules.watermark.position || 'bottom-right';
              document.getElementById('watermarkOpacity').value = rules.watermark.opacity || 0.8;
            }
          }
          document.getElementById('formFieldModalTitle').textContent = 'Edit Form Field';
        }

        toggleOptionsSection();
        renderOptions();
        document.getElementById('formFieldModal').classList.add('show');
      }

      function closeFormFieldModal() {
        document.getElementById('formFieldModal').classList.remove('show');
      }

      async function saveFormField() {
        const id = document.getElementById('fieldId').value;
        const fieldType = document.getElementById('fieldType').value;
        
        // Build validation rules based on field type
        let validationRules = null;
        if (fieldType === 'file') {
          validationRules = {
            maxFiles: parseInt(document.getElementById('maxFiles').value) || 3,
            maxSizeMB: parseInt(document.getElementById('maxSizeMB').value) || 5,
            acceptedTypes: ['image/jpeg', 'image/png'],
            watermark: {
              enabled: document.getElementById('watermarkEnabled').checked,
              showGPS: document.getElementById('watermarkShowGPS').checked,
              showTimestamp: document.getElementById('watermarkShowTimestamp').checked,
              position: document.getElementById('watermarkPosition').value,
              opacity: parseFloat(document.getElementById('watermarkOpacity').value) || 0.8
            }
          };
        }
        
        const data = {
          fieldName: document.getElementById('fieldName').value,
          fieldLabel: document.getElementById('fieldLabel').value,
          fieldType: fieldType,
          fieldGroup: document.getElementById('fieldGroup').value,
          displayOrder: parseInt(document.getElementById('displayOrder').value) || 0,
          isRequired: document.getElementById('isRequired').checked,
          isActive: document.getElementById('isActive').checked,
          helpText: document.getElementById('helpText').value,
          dropdownOptions: fieldType === 'dropdown' ? currentOptions : null,
          validationRules: validationRules
        };

        try {
          const url = id ? `/api/admin/complaint-form-config/${id}` : '/api/admin/complaint-form-config';
          const method = id ? 'PUT' : 'POST';
          const res = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          if (res.ok) {
            closeFormFieldModal();
            loadFormFields();
          } else {
            alert('Failed to save');
          }
        } catch (e) {
          alert('Error: ' + e.message);
        }
      }

      async function deleteFormField(id) {
        if (!confirm('Delete this field?')) return;
        try {
          await fetch(`/api/admin/complaint-form-config/${id}`, { method: 'DELETE' });
          loadFormFields();
        } catch (e) {
          alert('Error: ' + e.message);
        }
      }

      const groupLabels = {
        complainant: 'Complainant',
        establishment: 'Establishment',
        incident: 'Incident',
        location: 'Location',
        evidence: 'Evidence'
      };
      
      const typeLabels = {
        text: 'Text',
        textarea: 'Text Area',
        dropdown: 'Dropdown',
        date: 'Date',
        phone: 'Phone',
        email: 'Email',
        file: 'File Upload',
        location: 'GPS Location'
      };
      
      function getFieldSummary(f) {
        let summary = '';
        if (f.fieldType === 'dropdown' && f.dropdownOptions) {
          summary = `${f.dropdownOptions.length} options`;
        } else if (f.fieldType === 'file' && f.validationRules) {
          const rules = f.validationRules;
          const parts = [];
          if (rules.maxFiles) parts.push(`Max ${rules.maxFiles} files`);
          if (rules.watermark?.enabled) parts.push('Watermark ON');
          summary = parts.join(', ');
        }
        return summary;
      }

      async function loadFormFields() {
        try {
          const res = await fetch('/api/complaints/form-config');
          const fields = await res.json();
          const tbody = document.getElementById('formFieldsTableBody');
          if (fields.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="empty-state"><h3>No form fields configured</h3></td></tr>';
            return;
          }
          tbody.innerHTML = fields.map(f => `
            <tr>
              <td><code>${f.fieldName}</code></td>
              <td>${f.fieldLabel}</td>
              <td>${typeLabels[f.fieldType] || f.fieldType}${getFieldSummary(f) ? '<br><small style="color:#6b7280">' + getFieldSummary(f) + '</small>' : ''}</td>
              <td>${groupLabels[f.fieldGroup] || f.fieldGroup}</td>
              <td>${f.isRequired ? 'Yes' : 'No'}</td>
              <td><span class="status-badge ${f.isActive ? 'status-active' : 'status-inactive'}">${f.isActive ? 'Active' : 'Inactive'}</span></td>
              <td class="action-btns">
                <button class="action-btn edit-btn" onclick='openFormFieldModal(${JSON.stringify(f)})'>Edit</button>
                <button class="action-btn delete-btn" onclick="deleteFormField('${f.id}')">Delete</button>
              </td>
            </tr>
          `).join('');
        } catch (e) {
          console.error('Failed to load form fields:', e);
        }
      }

      function openWorkflowModal(workflow = null) {
        document.getElementById('transitionId').value = '';
        document.getElementById('fromStatus').value = 'pending';
        document.getElementById('toStatus').value = 'assigned';
        document.getElementById('transitionName').value = '';
        document.getElementById('requiredRole').value = '';
        document.getElementById('requiresEvidence').checked = false;
        document.getElementById('requiresRemarks').checked = false;
        document.getElementById('workflowActive').checked = true;
        document.getElementById('workflowModalTitle').textContent = 'Add Status Transition';

        if (workflow) {
          document.getElementById('transitionId').value = workflow.id;
          document.getElementById('fromStatus').value = workflow.fromStatus;
          document.getElementById('toStatus').value = workflow.toStatus;
          document.getElementById('transitionName').value = workflow.transitionName;
          document.getElementById('requiredRole').value = workflow.requiredRole || '';
          document.getElementById('requiresEvidence').checked = workflow.requiresEvidence;
          document.getElementById('requiresRemarks').checked = workflow.requiresRemarks;
          document.getElementById('workflowActive').checked = workflow.isActive;
          document.getElementById('workflowModalTitle').textContent = 'Edit Status Transition';
        }

        document.getElementById('workflowModal').classList.add('show');
      }

      function closeWorkflowModal() {
        document.getElementById('workflowModal').classList.remove('show');
      }

      async function saveWorkflow() {
        const id = document.getElementById('transitionId').value;
        const data = {
          fromStatus: document.getElementById('fromStatus').value,
          toStatus: document.getElementById('toStatus').value,
          transitionName: document.getElementById('transitionName').value,
          requiredRole: document.getElementById('requiredRole').value || null,
          requiresEvidence: document.getElementById('requiresEvidence').checked,
          requiresRemarks: document.getElementById('requiresRemarks').checked,
          isActive: document.getElementById('workflowActive').checked
        };

        try {
          const url = id ? `/api/admin/complaint-status-workflow/${id}` : '/api/admin/complaint-status-workflow';
          const method = id ? 'PUT' : 'POST';
          const res = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          if (res.ok) {
            closeWorkflowModal();
            loadWorkflows();
          } else {
            alert('Failed to save');
          }
        } catch (e) {
          alert('Error: ' + e.message);
        }
      }

      async function deleteWorkflow(id) {
        if (!confirm('Delete this transition?')) return;
        try {
          await fetch(`/api/admin/complaint-status-workflow/${id}`, { method: 'DELETE' });
          loadWorkflows();
        } catch (e) {
          alert('Error: ' + e.message);
        }
      }

      async function loadWorkflows() {
        try {
          const res = await fetch('/api/admin/complaint-status-workflows');
          const workflows = await res.json();
          const tbody = document.getElementById('workflowTableBody');
          if (workflows.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><h3>No workflows configured</h3></td></tr>';
            return;
          }
          tbody.innerHTML = workflows.map(w => `
            <tr>
              <td><span class="status-badge status-pending">${w.fromStatus}</span></td>
              <td><span class="status-badge status-assigned">${w.toStatus}</span></td>
              <td>${w.transitionName}</td>
              <td>${w.requiredRole || 'Any'}</td>
              <td><span class="status-badge ${w.isActive ? 'status-active' : 'status-inactive'}">${w.isActive ? 'Active' : 'Inactive'}</span></td>
              <td class="action-btns">
                <button class="action-btn edit-btn" onclick='openWorkflowModal(${JSON.stringify(w)})'>Edit</button>
                <button class="action-btn delete-btn" onclick="deleteWorkflow('${w.id}')">Delete</button>
              </td>
            </tr>
          `).join('');
        } catch (e) {
          console.error('Failed to load workflows:', e);
        }
      }

      async function loadComplaints() {
        try {
          const res = await fetch('/api/complaints');
          allComplaints = await res.json();
          renderComplaints(allComplaints);
          updateStats(allComplaints);
        } catch (e) {
          console.error('Failed to load complaints:', e);
        }
      }

      function renderComplaints(complaints) {
        const tbody = document.getElementById('complaintsTableBody');
        if (complaints.length === 0) {
          tbody.innerHTML = `
            <tr><td colspan="7" class="empty-state">
              <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
              <h3>No complaints found</h3>
              <p>Complaints submitted through the mobile app will appear here.</p>
            </td></tr>`;
          return;
        }
        tbody.innerHTML = complaints.map(c => `
          <tr>
            <td><span class="complaint-code">${c.complaintCode || c.id.slice(0, 8)}</span></td>
            <td>
              <div>${c.complainantName || 'Anonymous'}</div>
              <div style="font-size:12px;color:#6b7280">${c.complainantMobile || ''}</div>
            </td>
            <td>
              <div>${c.complaintType || '-'}</div>
              <div style="font-size:12px;color:#6b7280">${c.complaintNature || '-'}</div>
            </td>
            <td class="truncate">${c.establishmentName || c.incidentDescription?.slice(0, 30) || '-'}</td>
            <td><span class="status-badge status-${c.status || 'pending'}">${c.status || 'pending'}</span></td>
            <td class="date-cell">${c.submittedAt ? new Date(c.submittedAt).toLocaleDateString() : '-'}</td>
            <td class="action-btns">
              <button class="action-btn view-btn" onclick="viewComplaint('${c.id}')">View</button>
            </td>
          </tr>
        `).join('');
      }

      function filterComplaints() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const status = document.getElementById('statusFilter').value;
        let filtered = allComplaints;
        if (search) {
          filtered = filtered.filter(c => 
            (c.complaintCode || '').toLowerCase().includes(search) ||
            (c.complainantName || '').toLowerCase().includes(search)
          );
        }
        if (status) {
          filtered = filtered.filter(c => c.status === status);
        }
        renderComplaints(filtered);
      }

      function updateStats(complaints) {
        document.getElementById('totalComplaints').textContent = complaints.length;
        document.getElementById('pendingComplaints').textContent = complaints.filter(c => c.status === 'pending' || !c.status).length;
        document.getElementById('assignedComplaints').textContent = complaints.filter(c => c.status === 'assigned' || c.status === 'under_investigation').length;
        document.getElementById('resolvedComplaints').textContent = complaints.filter(c => c.status === 'resolved' || c.status === 'closed').length;
      }

      async function viewComplaint(id) {
        try {
          const res = await fetch(`/api/complaints/${id}`);
          const c = await res.json();
          document.getElementById('complaintDetailContent').innerHTML = `
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
              <div><strong>Complaint ID:</strong> ${c.complaintCode || c.id}</div>
              <div><strong>Status:</strong> <span class="status-badge status-${c.status || 'pending'}">${c.status || 'pending'}</span></div>
              <div><strong>Type:</strong> ${c.complaintType || '-'}</div>
              <div><strong>Nature:</strong> ${c.complaintNature || '-'}</div>
              <div><strong>Complainant:</strong> ${c.complainantName || 'Anonymous'}</div>
              <div><strong>Mobile:</strong> ${c.complainantMobile || '-'}</div>
              <div><strong>Email:</strong> ${c.complainantEmail || '-'}</div>
              <div><strong>Submitted:</strong> ${c.submittedAt ? new Date(c.submittedAt).toLocaleString() : '-'}</div>
              <div style="grid-column:span 2;"><strong>Establishment:</strong> ${c.establishmentName || '-'}</div>
              <div style="grid-column:span 2;"><strong>Description:</strong><br>${c.incidentDescription || '-'}</div>
              <div style="grid-column:span 2;"><strong>Location:</strong> ${c.location?.address || (c.location?.latitude ? `${c.location.latitude}, ${c.location.longitude}` : '-')}</div>
            </div>
          `;
          document.getElementById('complaintDetailModal').classList.add('show');
        } catch (e) {
          alert('Failed to load complaint details');
        }
      }

      function closeComplaintDetailModal() {
        document.getElementById('complaintDetailModal').classList.remove('show');
      }

      // Shared Links Functions
      let districts = [];
      
      async function loadDistricts() {
        try {
          const res = await fetch('/api/districts');
          if (res.ok) {
            districts = await res.json();
            const select = document.getElementById('linkDistrictId');
            select.innerHTML = '<option value="">Select district...</option>';
            districts.forEach(d => {
              const opt = document.createElement('option');
              opt.value = d.id;
              opt.textContent = d.name + (d.abbreviation ? ` (${d.abbreviation})` : '');
              select.appendChild(opt);
            });
          }
        } catch (e) {
          console.error('Failed to load districts:', e);
        }
      }
      
      async function loadSharedLinks() {
        try {
          const res = await fetch('/api/admin/shared-complaint-links');
          const links = await res.json();
          const tbody = document.getElementById('sharedLinksTableBody');
          
          if (!links || links.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="empty-state"><h3>No shared links created</h3><p>Create a link to allow public complaint submissions</p></td></tr>';
            return;
          }
          
          const baseUrl = window.location.origin;
          tbody.innerHTML = links.map(link => {
            const fullUrl = `${baseUrl}/complaint?token=${link.token}`;
            const district = districts.find(d => d.id === link.districtId);
            const districtName = district ? district.name : (link.districtAbbreviation || 'Unknown');
            const expiresText = link.expiresAt ? new Date(link.expiresAt).toLocaleDateString() : 'Never';
            const isActive = link.status === 'active';
            
            return `
              <tr>
                <td>${districtName}</td>
                <td>
                  <span class="link-text" title="${fullUrl}">${fullUrl}</span>
                  <button class="copy-btn" onclick="copyToClipboard('${fullUrl}', this)">
                    <svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                    Copy
                  </button>
                </td>
                <td>${expiresText}</td>
                <td><span class="status-badge ${isActive ? 'status-active' : 'status-inactive'}">${isActive ? 'Active' : link.status}</span></td>
                <td class="action-btns">
                  <button class="action-btn delete-btn" onclick="deleteSharedLink('${link.id}')">Delete</button>
                </td>
              </tr>
            `;
          }).join('');
        } catch (e) {
          console.error('Failed to load shared links:', e);
        }
      }
      
      function copyToClipboard(text, btn) {
        navigator.clipboard.writeText(text).then(() => {
          const originalText = btn.innerHTML;
          btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg> Copied!';
          setTimeout(() => { btn.innerHTML = originalText; }, 2000);
        }).catch(() => {
          alert('Failed to copy');
        });
      }
      
      function openCreateLinkModal() {
        document.getElementById('linkDistrictId').value = '';
        document.getElementById('linkExpiresAt').value = '';
        document.getElementById('createLinkModal').classList.add('show');
      }
      
      function closeCreateLinkModal() {
        document.getElementById('createLinkModal').classList.remove('show');
      }
      
      async function createSharedLink() {
        const districtId = document.getElementById('linkDistrictId').value;
        if (!districtId) {
          alert('Please select a district');
          return;
        }
        
        const data = {
          districtId,
          expiresAt: document.getElementById('linkExpiresAt').value || null
        };
        
        try {
          const res = await fetch('/api/admin/shared-complaint-links', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          
          if (res.ok) {
            closeCreateLinkModal();
            loadSharedLinks();
          } else {
            const err = await res.json();
            alert(err.error || 'Failed to create link');
          }
        } catch (e) {
          alert('Error: ' + e.message);
        }
      }
      
      async function deleteSharedLink(id) {
        if (!confirm('Delete this shared link?')) return;
        try {
          const res = await fetch(`/api/admin/shared-complaint-links/${id}`, { method: 'DELETE' });
          if (res.ok) {
            loadSharedLinks();
          } else {
            alert('Failed to delete');
          }
        } catch (e) {
          alert('Error: ' + e.message);
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        loadFormFields();
        loadWorkflows();
        loadComplaints();
        loadDistricts().then(() => loadSharedLinks());
      });
    </script>
  </body>
</html>
