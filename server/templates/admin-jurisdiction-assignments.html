<!doctype html>
<html>
  <head>
    <title>Officer Assignments - Food Safety Inspector</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      * { box-sizing: border-box; margin: 0; padding: 0; }
      body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f3f4f6; min-height: 100vh; }
      .header { background: #1E40AF; color: white; padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; }
      .header-left { display: flex; align-items: center; gap: 12px; }
      .header-logo { width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; }
      .header-logo svg { width: 24px; height: 24px; fill: white; }
      .header-title { font-size: 18px; font-weight: 600; }
      .back-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 16px; border-radius: 6px; font-size: 14px; cursor: pointer; text-decoration: none; }
      .back-btn:hover { background: rgba(255,255,255,0.2); }
      .main { padding: 24px; max-width: 1400px; margin: 0 auto; }
      .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
      .page-title { font-size: 24px; font-weight: 700; color: #1f2937; }
      .add-btn { background: #1E40AF; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; }
      .add-btn:hover { background: #1e3a8a; }
      .add-btn svg { width: 20px; height: 20px; fill: white; }
      .filters { display: flex; gap: 16px; margin-bottom: 24px; flex-wrap: wrap; }
      .filter-group { display: flex; flex-direction: column; gap: 4px; }
      .filter-label { font-size: 12px; font-weight: 500; color: #6b7280; }
      .filter-select { padding: 8px 12px; font-size: 14px; border: 1px solid #d1d5db; border-radius: 6px; outline: none; min-width: 180px; }
      .filter-select:focus { border-color: #1E40AF; }
      .card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; }
      table { width: 100%; border-collapse: collapse; }
      th { background: #f9fafb; padding: 12px 16px; text-align: left; font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase; border-bottom: 1px solid #e5e7eb; }
      td { padding: 16px; border-bottom: 1px solid #e5e7eb; font-size: 14px; color: #1f2937; }
      tr:last-child td { border-bottom: none; }
      tr:hover { background: #f9fafb; }
      .badge { padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 500; display: inline-block; }
      .badge-role { background: #dbeafe; color: #1E40AF; }
      .badge-capacity { background: #ede9fe; color: #7c3aed; }
      .badge-jurisdiction { background: #d1fae5; color: #059669; }
      .badge-primary { background: #fef3c7; color: #d97706; }
      .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; }
      .status-active { background: #d1fae5; color: #059669; }
      .status-inactive { background: #fee2e2; color: #dc2626; }
      .status-expired { background: #f3f4f6; color: #6b7280; }
      .date-info { font-size: 12px; color: #6b7280; }
      .action-btns { display: flex; gap: 8px; }
      .action-btn { padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; border: none; }
      .edit-btn { background: #eff6ff; color: #1E40AF; }
      .edit-btn:hover { background: #dbeafe; }
      .delete-btn { background: #fef2f2; color: #dc2626; }
      .delete-btn:hover { background: #fee2e2; }
      .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
      .modal.show { display: flex; }
      .modal-content { background: white; border-radius: 12px; padding: 24px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
      .modal-title { font-size: 20px; font-weight: 600; margin-bottom: 20px; color: #1f2937; }
      .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
      .form-group { margin-bottom: 16px; }
      .form-label { display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 6px; }
      .form-input, .form-select { width: 100%; padding: 10px 14px; font-size: 14px; border: 1px solid #d1d5db; border-radius: 8px; outline: none; }
      .form-input:focus, .form-select:focus { border-color: #1E40AF; box-shadow: 0 0 0 3px rgba(30,64,175,0.1); }
      .form-checkbox { display: flex; align-items: center; gap: 8px; }
      .form-checkbox input { width: 18px; height: 18px; }
      .modal-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; }
      .cancel-btn { padding: 10px 20px; border: 1px solid #d1d5db; background: white; border-radius: 8px; font-size: 14px; cursor: pointer; }
      .cancel-btn:hover { background: #f9fafb; }
      .save-btn { padding: 10px 20px; background: #1E40AF; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; }
      .save-btn:hover { background: #1e3a8a; }
      .empty-state { padding: 60px 20px; text-align: center; color: #6b7280; }
      .empty-state svg { width: 64px; height: 64px; fill: #d1d5db; margin-bottom: 16px; }
      .empty-state h3 { font-size: 18px; color: #374151; margin-bottom: 8px; }
      .info-box { background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 16px; margin-bottom: 24px; }
      .info-box p { color: #1e40af; font-size: 14px; line-height: 1.5; }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="header-left">
        <div class="header-logo">
          <svg viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>
        </div>
        <div class="header-title">Officer Assignments</div>
      </div>
      <a href="/admin/jurisdiction" class="back-btn">Back to Jurisdiction</a>
    </header>

    <main class="main">
      <div class="info-box">
        <p>Assign officers to jurisdiction units with specific roles and capacities. Assignments can be time-bound with start and end dates. Historical assignments are preserved for audit purposes.</p>
      </div>

      <div class="page-header">
        <h1 class="page-title">Officer Assignments</h1>
        <button class="add-btn" onclick="openModal()">
          <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
          New Assignment
        </button>
      </div>

      <div class="filters">
        <div class="filter-group">
          <span class="filter-label">Filter by Officer</span>
          <select class="filter-select" id="filter-officer" onchange="filterAssignments()">
            <option value="">All Officers</option>
          </select>
        </div>
        <div class="filter-group">
          <span class="filter-label">Filter by Jurisdiction</span>
          <select class="filter-select" id="filter-jurisdiction" onchange="filterAssignments()">
            <option value="">All Jurisdictions</option>
          </select>
        </div>
        <div class="filter-group">
          <span class="filter-label">Filter by Status</span>
          <select class="filter-select" id="filter-status" onchange="filterAssignments()">
            <option value="">All Status</option>
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
          </select>
        </div>
      </div>

      <div class="card">
        <table>
          <thead>
            <tr>
              <th>Officer</th>
              <th>Jurisdiction</th>
              <th>Role</th>
              <th>Capacity</th>
              <th>Period</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="assignments-table"></tbody>
        </table>
        <div class="empty-state" id="empty-state" style="display: none;">
          <svg viewBox="0 0 24 24"><path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1z"/></svg>
          <h3>No Assignments Found</h3>
          <p>Click "New Assignment" to assign officers to jurisdictions</p>
        </div>
      </div>
    </main>

    <div class="modal" id="modal">
      <div class="modal-content">
        <h2 class="modal-title" id="modal-title">New Assignment</h2>
        <form id="assignment-form">
          <input type="hidden" id="assignment-id" />
          <div class="form-group">
            <label class="form-label">Officer *</label>
            <select class="form-select" id="officerId" required>
              <option value="">Select Officer</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Jurisdiction *</label>
            <select class="form-select" id="jurisdictionId" required>
              <option value="">Select Jurisdiction</option>
            </select>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Role *</label>
              <select class="form-select" id="roleId" required>
                <option value="">Select Role</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Capacity *</label>
              <select class="form-select" id="capacityId" required>
                <option value="">Select Capacity</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Start Date *</label>
              <input type="date" class="form-input" id="startDate" required />
            </div>
            <div class="form-group">
              <label class="form-label">End Date</label>
              <input type="date" class="form-input" id="endDate" />
            </div>
          </div>
          <div class="form-group">
            <label class="form-checkbox">
              <input type="checkbox" id="isPrimary" />
              <span>Primary Assignment (used for login context)</span>
            </label>
          </div>
          <div class="form-group">
            <label class="form-label">Status</label>
            <select class="form-select" id="status">
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
            </select>
          </div>
          <div class="modal-actions">
            <button type="button" class="cancel-btn" onclick="closeModal()">Cancel</button>
            <button type="submit" class="save-btn">Save Assignment</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      let assignments = [];
      let officers = [];
      let units = [];
      let levels = [];
      let roles = [];
      let capacities = [];
      let editingId = null;

      async function loadData() {
        try {
          const [assignmentsRes, officersRes, unitsRes, levelsRes, rolesRes, capacitiesRes] = await Promise.all([
            fetch('/api/admin/assignments'),
            fetch('/api/admin/officers'),
            fetch('/api/admin/units'),
            fetch('/api/admin/levels'),
            fetch('/api/admin/roles'),
            fetch('/api/admin/capacities')
          ]);
          assignments = await assignmentsRes.json();
          officers = await officersRes.json();
          units = await unitsRes.json();
          levels = await levelsRes.json();
          roles = await rolesRes.json();
          capacities = await capacitiesRes.json();
          
          populateDropdowns();
          populateFilters();
          renderTable();
        } catch (error) {
          console.error('Failed to load data:', error);
        }
      }

      function getOfficerName(officerId) {
        const officer = officers.find(o => o.id === officerId);
        return officer ? officer.name : 'Unknown';
      }

      function getUnitName(unitId) {
        const unit = units.find(u => u.id === unitId);
        if (!unit) return 'Unknown';
        const level = levels.find(l => l.id === unit.levelId);
        return `${unit.name} (${level?.levelName || ''})`;
      }

      function getRoleName(roleId) {
        const role = roles.find(r => r.id === roleId);
        return role ? role.name : 'Unknown';
      }

      function getCapacityName(capacityId) {
        const capacity = capacities.find(c => c.id === capacityId);
        return capacity ? capacity.name : 'Unknown';
      }

      function formatDate(date) {
        if (!date) return '-';
        return new Date(date).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
      }

      function getAssignmentStatus(assignment) {
        if (assignment.status === 'inactive') return 'inactive';
        if (assignment.endDate && new Date(assignment.endDate) < new Date()) return 'expired';
        return 'active';
      }

      function populateDropdowns() {
        const officerSelect = document.getElementById('officerId');
        officerSelect.innerHTML = '<option value="">Select Officer</option>' +
          officers.filter(o => o.status === 'active').map(o => 
            `<option value="${o.id}">${o.name} (${o.email})</option>`
          ).join('');

        const jurisdictionSelect = document.getElementById('jurisdictionId');
        jurisdictionSelect.innerHTML = '<option value="">Select Jurisdiction</option>' +
          units.filter(u => u.status === 'active').map(u => {
            const level = levels.find(l => l.id === u.levelId);
            return `<option value="${u.id}">${u.name} (${level?.levelName || ''})</option>`;
          }).join('');

        const roleSelect = document.getElementById('roleId');
        roleSelect.innerHTML = '<option value="">Select Role</option>' +
          roles.filter(r => r.status === 'active').map(r => 
            `<option value="${r.id}">${r.name}</option>`
          ).join('');

        const capacitySelect = document.getElementById('capacityId');
        capacitySelect.innerHTML = '<option value="">Select Capacity</option>' +
          capacities.filter(c => c.status === 'active').map(c => 
            `<option value="${c.id}">${c.name}</option>`
          ).join('');
      }

      function populateFilters() {
        const filterOfficer = document.getElementById('filter-officer');
        filterOfficer.innerHTML = '<option value="">All Officers</option>' +
          officers.map(o => `<option value="${o.id}">${o.name}</option>`).join('');

        const filterJurisdiction = document.getElementById('filter-jurisdiction');
        filterJurisdiction.innerHTML = '<option value="">All Jurisdictions</option>' +
          units.map(u => `<option value="${u.id}">${u.name}</option>`).join('');
      }

      function filterAssignments() {
        renderTable();
      }

      function renderTable() {
        const tbody = document.getElementById('assignments-table');
        const emptyState = document.getElementById('empty-state');
        
        const filterOfficer = document.getElementById('filter-officer').value;
        const filterJurisdiction = document.getElementById('filter-jurisdiction').value;
        const filterStatus = document.getElementById('filter-status').value;
        
        let filtered = assignments;
        if (filterOfficer) filtered = filtered.filter(a => a.officerId === filterOfficer);
        if (filterJurisdiction) filtered = filtered.filter(a => a.jurisdictionId === filterJurisdiction);
        if (filterStatus) filtered = filtered.filter(a => getAssignmentStatus(a) === filterStatus);
        
        if (filtered.length === 0) {
          tbody.innerHTML = '';
          emptyState.style.display = 'block';
          return;
        }
        
        emptyState.style.display = 'none';
        tbody.innerHTML = filtered.map(assignment => {
          const status = getAssignmentStatus(assignment);
          return `
            <tr>
              <td><strong>${getOfficerName(assignment.officerId)}</strong></td>
              <td><span class="badge badge-jurisdiction">${getUnitName(assignment.jurisdictionId)}</span></td>
              <td><span class="badge badge-role">${getRoleName(assignment.roleId)}</span></td>
              <td>
                <span class="badge badge-capacity">${getCapacityName(assignment.capacityId)}</span>
                ${assignment.isPrimary ? '<span class="badge badge-primary">Primary</span>' : ''}
              </td>
              <td>
                <div class="date-info">From: ${formatDate(assignment.startDate)}</div>
                <div class="date-info">To: ${formatDate(assignment.endDate)}</div>
              </td>
              <td><span class="status-badge status-${status}">${status}</span></td>
              <td>
                <div class="action-btns">
                  <button class="action-btn edit-btn" onclick="editAssignment('${assignment.id}')">Edit</button>
                  <button class="action-btn delete-btn" onclick="deleteAssignment('${assignment.id}')">Delete</button>
                </div>
              </td>
            </tr>
          `;
        }).join('');
      }

      function openModal(assignment = null) {
        const modal = document.getElementById('modal');
        const title = document.getElementById('modal-title');
        const form = document.getElementById('assignment-form');
        
        if (assignment) {
          title.textContent = 'Edit Assignment';
          document.getElementById('assignment-id').value = assignment.id;
          document.getElementById('officerId').value = assignment.officerId;
          document.getElementById('jurisdictionId').value = assignment.jurisdictionId;
          document.getElementById('roleId').value = assignment.roleId;
          document.getElementById('capacityId').value = assignment.capacityId;
          document.getElementById('startDate').value = assignment.startDate ? assignment.startDate.split('T')[0] : '';
          document.getElementById('endDate').value = assignment.endDate ? assignment.endDate.split('T')[0] : '';
          document.getElementById('isPrimary').checked = assignment.isPrimary;
          document.getElementById('status').value = assignment.status;
          editingId = assignment.id;
        } else {
          title.textContent = 'New Assignment';
          form.reset();
          document.getElementById('assignment-id').value = '';
          document.getElementById('startDate').value = new Date().toISOString().split('T')[0];
          editingId = null;
        }
        
        modal.classList.add('show');
      }

      function closeModal() {
        document.getElementById('modal').classList.remove('show');
        editingId = null;
      }

      function editAssignment(id) {
        const assignment = assignments.find(a => a.id === id);
        if (assignment) openModal(assignment);
      }

      async function deleteAssignment(id) {
        if (!confirm('Are you sure you want to delete this assignment? Historical data will be lost.')) return;
        
        try {
          await fetch(`/api/admin/assignments/${id}`, { method: 'DELETE' });
          loadData();
        } catch (error) {
          alert('Failed to delete assignment');
        }
      }

      document.getElementById('assignment-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const data = {
          officerId: document.getElementById('officerId').value,
          jurisdictionId: document.getElementById('jurisdictionId').value,
          roleId: document.getElementById('roleId').value,
          capacityId: document.getElementById('capacityId').value,
          startDate: document.getElementById('startDate').value,
          endDate: document.getElementById('endDate').value || null,
          isPrimary: document.getElementById('isPrimary').checked,
          status: document.getElementById('status').value,
        };

        try {
          const url = editingId ? `/api/admin/assignments/${editingId}` : '/api/admin/assignments';
          const method = editingId ? 'PUT' : 'POST';
          
          const response = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
          });

          if (response.ok) {
            closeModal();
            loadData();
          } else {
            const error = await response.json();
            alert(error.error || 'Failed to save assignment');
          }
        } catch (error) {
          alert('Failed to save assignment');
        }
      });

      loadData();
    </script>
  </body>
</html>
